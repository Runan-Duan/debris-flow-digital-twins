<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GeoServer Diagnostic Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .test-section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-number {
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.2s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .result-box {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-box pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .test-image {
            max-width: 100%;
            margin-top: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .info-box strong {
            color: #1976D2;
        }
        
        .copy-btn {
            background: #28a745;
            padding: 6px 12px;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç GeoServer Diagnostic Tool</h1>
            <p>Test your GeoServer connection and layers step-by-step</p>
        </div>
        
        <div class="content">
            <!-- Configuration -->
            <div class="test-section">
                <h2>
                    <span class="test-number">‚öôÔ∏è</span>
                    Configuration
                </h2>
                <div class="form-group">
                    <label>GeoServer URL</label>
                    <input type="text" id="geoserverUrl" value="http://localhost:8888/geoserver">
                </div>
                <div class="form-group">
                    <label>Workspace</label>
                    <input type="text" id="workspace" value="tirol">
                </div>
                <div class="form-group">
                    <label>Layer Name</label>
                    <input type="text" id="layerName" value="ortho_image">
                </div>
            </div>
            
            <!-- Test 1: GeoServer Connection -->
            <div class="test-section">
                <h2>
                    <span class="test-number">1</span>
                    Test GeoServer Connection
                </h2>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    Check if GeoServer is running and accessible
                </p>
                <button class="btn" onclick="testConnection()">üîå Test Connection</button>
                <div id="connection-result"></div>
            </div>
            
            <!-- Test 2: Check Layer Capabilities -->
            <div class="test-section">
                <h2>
                    <span class="test-number">2</span>
                    Check WMS Capabilities
                </h2>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    Retrieve layer information and bounding box
                </p>
                <button class="btn" onclick="checkCapabilities()">üìã Get Capabilities</button>
                <div id="capabilities-result"></div>
            </div>
            
            <!-- Test 3: Test WMS GetMap -->
            <div class="test-section">
                <h2>
                    <span class="test-number">3</span>
                    Test WMS GetMap Request
                </h2>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    Try to retrieve an actual image from your layer
                </p>
                <button class="btn" onclick="testGetMap()">üñºÔ∏è Get Map Image</button>
                <div id="getmap-result"></div>
            </div>
            
            <!-- Test 4: CORS Test -->
            <div class="test-section">
                <h2>
                    <span class="test-number">4</span>
                    Test CORS Configuration
                </h2>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    Check if Cross-Origin Resource Sharing is enabled
                </p>
                <button class="btn" onclick="testCORS()">üîí Test CORS</button>
                <div id="cors-result"></div>
            </div>
            
            <div class="info-box">
                <strong>üí° Tip:</strong> Run tests in order from 1 to 4. Each test builds on the previous one.
                If a test fails, fix that issue before proceeding to the next test.
            </div>
        </div>
    </div>
    
    <script>
        let layerBounds = null;
        
        // Test 1: Connection
        async function testConnection() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '<span class="status status-pending">‚è≥ Testing...</span>';
            
            const url = document.getElementById('geoserverUrl').value;
            const testUrl = url + '/web/';
            
            try {
                const response = await fetch(testUrl, { method: 'HEAD' });
                
                if (response.ok || response.status === 401) {
                    resultDiv.innerHTML = `
                        <span class="status status-success">‚úì SUCCESS</span>
                        <div class="result-box">
                            <strong>GeoServer is running!</strong><br>
                            URL: ${url}<br>
                            Status: Connected<br><br>
                            ‚úì You can proceed to Test 2
                        </div>
                    `;
                } else {
                    throw new Error('Unexpected response');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="status status-error">‚úó FAILED</span>
                    <div class="result-box">
                        <strong>Cannot connect to GeoServer</strong><br>
                        Error: ${error.message}<br><br>
                        <strong>Solutions:</strong><br>
                        1. Make sure GeoServer is running<br>
                        2. Check the URL is correct (${url})<br>
                        3. Try opening ${url} in a new browser tab
                    </div>
                `;
            }
        }
        
        // Test 2: Capabilities
        async function checkCapabilities() {
            const resultDiv = document.getElementById('capabilities-result');
            resultDiv.innerHTML = '<span class="status status-pending">‚è≥ Checking...</span>';
            
            const geoserverUrl = document.getElementById('geoserverUrl').value;
            const workspace = document.getElementById('workspace').value;
            const layerName = document.getElementById('layerName').value;
            
            const capsUrl = `${geoserverUrl}/wms?service=WMS&version=1.1.0&request=GetCapabilities`;
            
            try {
                const response = await fetch(capsUrl);
                const text = await response.text();
                
                // Parse XML to find layer
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                
                // Find the layer
                const layers = xml.getElementsByTagName('Layer');
                let foundLayer = null;
                
                for (let layer of layers) {
                    const nameEl = layer.getElementsByTagName('Name')[0];
                    if (nameEl && nameEl.textContent === `${workspace}:${layerName}`) {
                        foundLayer = layer;
                        break;
                    }
                }
                
                if (foundLayer) {
                    // Get bounding box
                    const bboxEl = foundLayer.getElementsByTagName('BoundingBox')[0];
                    if (bboxEl) {
                        const minx = bboxEl.getAttribute('minx');
                        const miny = bboxEl.getAttribute('miny');
                        const maxx = bboxEl.getAttribute('maxx');
                        const maxy = bboxEl.getAttribute('maxy');
                        const srs = bboxEl.getAttribute('SRS') || bboxEl.getAttribute('CRS');
                        
                        layerBounds = { minx, miny, maxx, maxy, srs };
                        
                        resultDiv.innerHTML = `
                            <span class="status status-success">‚úì FOUND</span>
                            <div class="result-box">
                                <strong>Layer found in GeoServer!</strong><br><br>
                                <strong>Layer:</strong> ${workspace}:${layerName}<br>
                                <strong>SRS:</strong> ${srs}<br>
                                <strong>Bounding Box:</strong><br>
                                &nbsp;&nbsp;Min X: ${minx}<br>
                                &nbsp;&nbsp;Min Y: ${miny}<br>
                                &nbsp;&nbsp;Max X: ${maxx}<br>
                                &nbsp;&nbsp;Max Y: ${maxy}<br><br>
                                ‚úì Proceed to Test 3 to get the image
                            </div>
                        `;
                    } else {
                        throw new Error('No bounding box found for layer');
                    }
                } else {
                    throw new Error('Layer not found in capabilities');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="status status-error">‚úó FAILED</span>
                    <div class="result-box">
                        <strong>Layer not found or error</strong><br>
                        Error: ${error.message}<br><br>
                        <strong>Looking for:</strong> ${workspace}:${layerName}<br><br>
                        <strong>Solutions:</strong><br>
                        1. Check the workspace name is correct<br>
                        2. Check the layer name is correct<br>
                        3. Make sure you published the layer in GeoServer<br>
                        4. Go to GeoServer ‚Üí Layer Preview and verify the layer exists
                    </div>
                `;
            }
        }
        
        // Test 3: GetMap
        async function testGetMap() {
            const resultDiv = document.getElementById('getmap-result');
            
            if (!layerBounds) {
                resultDiv.innerHTML = `
                    <span class="status status-error">‚úó ERROR</span>
                    <div class="result-box">
                        Please run Test 2 first to get the bounding box!
                    </div>
                `;
                return;
            }
            
            resultDiv.innerHTML = '<span class="status status-pending">‚è≥ Loading image...</span>';
            
            const geoserverUrl = document.getElementById('geoserverUrl').value;
            const workspace = document.getElementById('workspace').value;
            const layerName = document.getElementById('layerName').value;
            
            const bbox = `${layerBounds.minx},${layerBounds.miny},${layerBounds.maxx},${layerBounds.maxy}`;
            const getMapUrl = `${geoserverUrl}/wms?service=WMS&version=1.1.0&request=GetMap&layers=${workspace}:${layerName}&bbox=${bbox}&width=512&height=512&srs=${layerBounds.srs}&format=image/png`;
            
            try {
                const img = new Image();
                img.onload = function() {
                    resultDiv.innerHTML = `
                        <span class="status status-success">‚úì SUCCESS</span>
                        <div class="result-box">
                            <strong>Image loaded successfully!</strong><br><br>
                            <strong>Test URL:</strong><br>
                            <a href="${getMapUrl}" target="_blank" style="color: #667eea; word-break: break-all;">${getMapUrl}</a>
                            <button class="btn copy-btn" onclick="copyToClipboard('${getMapUrl}')">üìã Copy URL</button>
                        </div>
                        <img src="${getMapUrl}" class="test-image" alt="Test map image">
                        <div class="result-box" style="margin-top: 15px;">
                            ‚úì Your layer is working!<br>
                            ‚úì Now run Test 4 to check CORS
                        </div>
                    `;
                };
                img.onerror = function() {
                    resultDiv.innerHTML = `
                        <span class="status status-error">‚úó FAILED</span>
                        <div class="result-box">
                            <strong>Image failed to load</strong><br><br>
                            <strong>Test URL:</strong><br>
                            <a href="${getMapUrl}" target="_blank" style="color: #667eea; word-break: break-all;">${getMapUrl}</a><br><br>
                            <strong>Solutions:</strong><br>
                            1. Click the URL above to see the error in a new tab<br>
                            2. Check if the layer preview works in GeoServer<br>
                            3. Verify the projection EPSG:31255 is configured correctly
                        </div>
                    `;
                };
                img.src = getMapUrl;
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="status status-error">‚úó ERROR</span>
                    <div class="result-box">Error: ${error.message}</div>
                `;
            }
        }
        
        // Test 4: CORS
        async function testCORS() {
            const resultDiv = document.getElementById('cors-result');
            resultDiv.innerHTML = '<span class="status status-pending">‚è≥ Testing CORS...</span>';
            
            const geoserverUrl = document.getElementById('geoserverUrl').value;
            const workspace = document.getElementById('workspace').value;
            const layerName = document.getElementById('layerName').value;
            
            const testUrl = `${geoserverUrl}/wms?service=WMS&version=1.1.0&request=GetCapabilities`;
            
            try {
                const response = await fetch(testUrl);
                const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                
                if (corsHeader) {
                    resultDiv.innerHTML = `
                        <span class="status status-success">‚úì ENABLED</span>
                        <div class="result-box">
                            <strong>CORS is properly configured!</strong><br><br>
                            Access-Control-Allow-Origin: ${corsHeader}<br><br>
                            ‚úì Your map should work in the 3D viewer!<br><br>
                            <strong>Next Steps:</strong><br>
                            1. Go back to your 3D map (tirol-3d-map.html)<br>
                            2. Click "Load Ortho Layer"<br>
                            3. Your image should appear on the map
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="status status-error">‚úó NOT ENABLED</span>
                        <div class="result-box">
                            <strong>CORS is not enabled in GeoServer</strong><br><br>
                            This will prevent your map from loading in the browser.<br><br>
                            <strong>Solution:</strong><br>
                            1. Login to GeoServer admin panel<br>
                            2. Go to Settings ‚Üí Global<br>
                            3. Scroll to "CORS Configuration"<br>
                            4. Check "Enable CORS"<br>
                            5. Set Allowed Origins to: *<br>
                            6. Click Submit and restart GeoServer<br><br>
                            OR manually edit web.xml to add CORS filter
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="status status-error">‚úó ERROR</span>
                    <div class="result-box">
                        <strong>CORS test failed</strong><br>
                        Error: ${error.message}<br><br>
                        This usually means CORS is not enabled.<br>
                        Follow the solution steps above to enable CORS.
                    </div>
                `;
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('URL copied to clipboard!');
            });
        }
    </script>
</body>
</html>